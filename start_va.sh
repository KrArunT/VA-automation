#!/bin/bash

IMAGE_NAME="sarthakd112/va_app:v1"
RABBITMQ_QUEUE="VA_AMD"
vLLM_ENDPOINT="http://10.216.172.152:8000/v1/chat/completions"

CPUSETS_PIPELINE=(
  "192,198,204,210,216,222,228,234,240,246,252,258,264,270,276,282,288,294,300,306,312,318,324,330,336,342,348,354,360,366,372,378"
  "193,199,205,211,217,223,229,235,241,247,253,259,265,271,277,283,289,295,301,307,313,319,325,331,337,343,349,355,361,367,373,379"
  "194,200,206,212,218,224,230,236,242,248,254,260,266,272,278,284,290,296,302,308,314,320,326,332,338,344,350,356,362,368,374,380"
  "195,201,207,213,219,225,231,237,243,249,255,261,267,273,279,285,291,297,303,309,315,321,327,333,339,345,351,357,363,369,375,381"
  "196,202,208,214,220,226,232,238,244,250,256,262,268,274,280,286,292,298,304,310,316,322,328,334,340,346,352,358,364,370,376,382"
  "197,203,209,215,221,227,233,239,245,251,257,263,269,275,281,287,293,299,305,311,317,323,329,335,341,347,353,359,365,371,377,383"
  "576,582,588,594,600,606,612,618,624,630,636,642,648,654,660,666,672,678,684,690,696,702,708,714,720,726,732,738,744,750,756,762"
  "577,583,589,595,601,607,613,619,625,631,637,643,649,655,661,667,673,679,685,691,697,703,709,715,721,727,733,739,745,751,757,763"
  "578,584,590,596,602,608,614,620,626,632,638,644,650,656,662,668,674,680,686,692,698,704,710,716,722,728,734,740,746,752,758,764"
  "579,585,591,597,603,609,615,621,627,633,639,645,651,657,663,669,675,681,687,693,699,705,711,717,723,729,735,741,747,753,759,765"
  "580,586,592,598,604,610,616,622,628,634,640,646,652,658,664,670,676,682,688,694,700,706,712,718,724,730,736,742,748,754,760,766"
  "581,587,593,599,605,611,617,623,629,635,641,647,653,659,665,671,677,683,689,695,701,707,713,719,725,731,737,743,749,755,761,767"
)

for i in "${!CPUSETS_PIPELINE[@]}"; do
  CONTAINER_NAME="va_app_instance_$((i+1))"
  CPU_SET="${CPUSETS_PIPELINE[$i]}"
  LOCAL_CSV_PATH="/home/amd/workspace/vademo/results/pipeline_data_$i.csv"

  # âœ… Create empty CSV file before mounting
  touch "$LOCAL_CSV_PATH"

  echo "ðŸš€ Starting $CONTAINER_NAME with CPUs $CPU_SET and queue $RABBITMQ_QUEUE..."

  docker run --rm -d \
    --name "$CONTAINER_NAME" \
    --cpuset-cpus="$CPU_SET" \
    -v "$LOCAL_CSV_PATH:/app/pipeline_data.csv" \
    -e "RABBITMQ_QUEUE=$RABBITMQ_QUEUE" \
    -e "vLLM_ENDPOINT=$vLLM_ENDPOINT" \
    "$IMAGE_NAME"
done
